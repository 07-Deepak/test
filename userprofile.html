<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sunteck Maxx World - Complaint Management</title>
  <link rel="shortcut icon" href="image/logo1.png" type="image/svg+xml">
  <link rel="stylesheet" href="css/userprofile.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

</head>

<body>

<header class="header">
  <nav>
    <a href="index.html"><img src="image/logo.png" id="logo-img" alt="Sunteck Maxx World"></a>
    <div class="nav-links" id="navLinks">
      <span class="icon" onclick="hidemenu()">&times;</span>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="#" onclick="logout()">Logout</a></li>
      </ul>
    </div>
    <span class="icon" onclick="showmenu()">&#9776;</span>
  </nav>
</header>

<main class="main-container">

  <section id="boxesContainer">
    <div class="clickable-box" onclick="showComplaintForm()">
      <h2>Raise a Complaint</h2>
      <p>Raise a ticket for quick resolution.</p>
    </div>

    <div class="clickable-box" onclick="window.location.href='services.html'">
      <h2>Status Of Complaint Raised</h2>
      <p>Submit your service request.</p>
    </div>

    <div class="clickable-box" onclick="viewComplaints()">
      <h2>View Complaints History</h2>
      <p>Review submitted complaints.</p>
    </div>
  </section>

  <!-- Complaint Form -->
  <section id="contactFormContainer" class="contact-form">
    <h2>Submit Your Complaint / Query</h2>
    <form id="contactForm">
      <label>Your Name</label>
      <input type="text" id="yourname" readonly required>

      <label>Email Address</label>
      <input type="email" id="emailaddress" readonly required>

      <label>Building Wing</label>
      <input type="text" id="wing" readonly required>

      <label>Floor</label>
      <input type="text" id="floornumber" readonly required>

      <label>Room Number</label>
      <input type="text" id="roomnumber" readonly required>

      <label>Issue</label>
      <select id="issue" required>
        <option value="">-- Select Issue --</option>
        <option value="Water Leakage">Water Leakage</option>
        <option value="Electricity Problem">Electricity Problem</option>
        <option value="Cleaning Required">Cleaning Required</option>
        <option value="Security Issue">Security Issue</option>
        <option value="Other">Other</option>
      </select>

      <label>Message</label>
      <textarea id="message" placeholder="Describe your issue..." required></textarea>

      <div class="form-actions">
        <input type="submit" class="button" value="Submit">
      </div>
    </form>

    <button class="back-button" onclick="goBackToMain()">⬅ Back</button>

    <div id="successMessage" class="success-msg" style="display:none;"></div>
    <div id="errorMessage" class="error-msg" style="display:none;">❌ An error occurred. Please try again.</div>
  </section>
</main>

<!-- Complaints History Modal -->
<div id="complaintsModal">
  <div id="complaintsContent">
    <span class="closeModal" onclick="closeComplaintsModal()">&times;</span>
    <h2>Your Submitted Complaints</h2>
    <ul id="complaintsList"></ul>
  </div>
</div>

<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyBuR-YwstGzMU9HSGrogNbBqTXN9hr6l80",
  authDomain: "sunteck1-36a23.firebaseapp.com",
  projectId: "sunteck1-36a23",
  storageBucket: "sunteck1-36a23.firebasestorage.app",
  messagingSenderId: "562096685576",
  appId: "1:562096685576:web:3bf98573623f55051107bd",
  measurementId: "G-ND03031XQ9"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

// Initialize EmailJS
emailjs.init("c44c8jGveAMxvpS8B"); // ✅ Your Public Key

let currentUserEmail = "", currentUserId = "";

// When user login state changes
auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUserEmail = user.email;
    currentUserId = user.uid;

    const snapshot = await database.ref('users/' + currentUserId).once('value');
    const userData = snapshot.val();

    document.getElementById("yourname").value = userData.name || "";
    document.getElementById("emailaddress").value = user.email || "";
    document.getElementById("wing").value = userData.type || "";
    document.getElementById("floornumber").value = userData.floor || "";
    document.getElementById("roomnumber").value = userData.room || "";
  } else {
    window.location.href = 'index.html';
  }
});

// Submit Complaint Form
document.getElementById("contactForm").addEventListener("submit", function(e) {
  e.preventDefault();

  const complaintRef = database.ref('contacts/' + currentUserId).push();
  const complaintId = complaintRef.key;
  const timestamp = new Date().toISOString();

  const complaintData = {
    complaintId,
    name: document.getElementById("yourname").value,
    email: document.getElementById("emailaddress").value,
    wing: document.getElementById("wing").value,
    floor: document.getElementById("floornumber").value,
    room: document.getElementById("roomnumber").value,
    issue: document.getElementById("issue").value,
    message: document.getElementById("message").value,
    timestamp
  };

  document.getElementById("successMessage").style.display = "none";
  document.getElementById("errorMessage").style.display = "none";

  complaintRef.set(complaintData)
    .then(() => {
      console.log("✅ Complaint saved in Firebase");
      sendEmailNotification(complaintData);
      document.getElementById("successMessage").innerText = `✅ Complaint ID: ${complaintId} submitted successfully!`;
      document.getElementById("successMessage").style.display = "block";
      document.getElementById("contactForm").reset();
      setTimeout(() => document.getElementById("successMessage").style.display = "none", 8000);
    })
    .catch((error) => {
      console.error("❌ Firebase Save Error", error);
      document.getElementById("errorMessage").style.display = "block";
    });
});

// EmailJS call
function sendEmailNotification(data) {
  emailjs.send("service_g27gp15", "template_i4wjczu", {
    complaint_id: data.complaintId,
    user_name: data.name,
    user_email: data.email,
    user_wing: data.wing,
    user_floor: data.floor,
    user_room: data.room,
    issue: data.issue,
    message: data.message
  }).then((response) => {
    console.log("✅ Email sent", response);
  }, (error) => {
    console.error("❌ EmailJS Error", error);
  });
}

function showmenu() { document.getElementById("navLinks").style.right = "0"; }
function hidemenu() { document.getElementById("navLinks").style.right = "-200px"; }
function logout() { auth.signOut().then(() => { window.location.href = 'index.html'; }) }

function showComplaintForm() {
  document.getElementById("boxesContainer").style.display = "none";
  document.getElementById("contactFormContainer").style.display = "block";
  window.scrollTo({ top: 0, behavior: 'smooth' });
}
function goBackToMain() {
  document.getElementById("contactFormContainer").style.display = "none";
  document.getElementById("boxesContainer").style.display = "block";
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// UPDATED View Complaints
    function viewComplaints() {
      document.getElementById("complaintsModal").style.display = "flex";
      const complaintsList = document.getElementById("complaintsList");
      complaintsList.innerHTML = "Loading...";

      database.ref('contacts/' + currentUserId).once('value')
        .then(snapshot => {
          complaintsList.innerHTML = "";

          if (snapshot.exists()) {
            let table = document.createElement("table");
            table.style.width = "100%";
            table.style.borderCollapse = "collapse";
            table.style.color = "#333";
            table.style.background = "#fff";
            table.style.border = "1px solid #ccc";

            let thead = document.createElement("thead");
            thead.innerHTML = `
              <tr style="background: #3e2093; color: white;">
                <th style="padding: 10px; border: 1px solid #ccc;">Complaint ID</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Date</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Time</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Issue</th>
                <th style="padding: 10px; border: 1px solid #ccc;">Message</th>
              </tr>`;
            table.appendChild(thead);

            let tbody = document.createElement("tbody");

            snapshot.forEach(childSnapshot => {
              const data = childSnapshot.val();
              const dateObj = new Date(data.timestamp);
              const date = dateObj.toLocaleDateString();
              const time = dateObj.toLocaleTimeString();

              let tr = document.createElement("tr");
              tr.innerHTML = `
                <td style="padding: 10px; border: 1px solid #ccc;">${data.complaintId}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">${date}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">${time}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">${data.issue}</td>
                <td style="padding: 10px; border: 1px solid #ccc;">${data.message}</td>`;
              tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            complaintsList.appendChild(table);
          } else {
            complaintsList.innerHTML = "<span style='color: black; font-weight: bold; font-size: 16px;'>No complaints found.</span>";
          }
        });
    }

    // Close Modal
    function closeComplaintsModal() {
      document.getElementById("complaintsModal").style.display = "none";
    }
</script>

</body>
</html>
